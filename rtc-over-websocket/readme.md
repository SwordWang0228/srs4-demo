## 音频编码
* web opus 编码器 ：https://github.com/ImagicTheCat/libopusjs

## 音频RTP封包
* 采用RTP封包或者其他通用格式。主要用于实现给编码数据带上时间戳传输。

## TCP队头阻塞问题
* 如果采用socket.io，单个长连接进行多对多的聊天，就可能出现某一个通话的丢包阻塞导致所有通话的阻塞。解决办法：在进行多对多聊天的时候应采用各自独立的长链接进行音频数据的传输。

## 基于报文延迟评估方法
时间戳同步
* 通过通信报文进行时间戳同步，且一直进行，且一直选取最低通信延迟的报文进行进行时间戳同步，可以加上一个固定的同步误差，以提高时间戳同步准确性。


```sequence
Title: 时间戳同步
A->B: STS1(source timestamp)
A->B: STS2(source timestamp)
```

> A发送报文STS1是时候STS = 1000 ，到达时B的STS是 2000，可以计算得到两方的时间戳插值1000。
A发送报文STS1是时候STS = 2000 ，到达时B的STS是 3030，可以得到两方的时间戳差值是1030。
可以得出STS2的传输延迟高于STS1。我们取STS进行时间戳同步。同时我们减去一个固定的同步误差，以减少同步误差。


动态缓冲和变速播放的实现和控制方法：
* 时间戳同步后可以评估每个报文的延迟。每50个报文计算一个平均延迟，通过平均延迟去设置音频动态缓冲区的大小，
* 当平均延迟大的时候，音频动态缓冲区大，音频通信延迟大，但可以保证声音平顺。当音频包低于播放缓冲线后，降低音频播放速度
* 当平均延迟小的时候，音频动态缓冲区小，音频通信延迟低，同样保证声音平顺。当音频包超过丢包缓冲线后，提高音频播放速度

>动态缓冲保证了在网络抖动的情况下兼顾通话质量和延迟。实现中我们没用使用丢包的方式来消除累计延迟，我们通过加速播放的方式来消除累计延迟。

