<!DOCTYPE html>
<html>

<head>
  <title>RTC COMM</title>
</head>

<body>
  <input type="text" id="userName" placeholder="User name" />
  <button onclick="login()">Login</button>
  <br />
  <br />
  <video autoplay width="200" height="200" id="video"></video>
  <video width="200" height="200" id="videoStream"></video>
  <button onclick="streamVideo()">推送视频</button>
  <button onclick="startPlayVideo()">不要点</button>
  <!-- <button id="play">play</button> -->
  <button onclick="captureImage()">播放视频</button>
  <!-- <div id="output"></div> -->
  <img id="target" width="480" height="320"></img>

  <div>
    <label for="audio">通话音质选择:</label>
    <select id="audio_mode">
      <option value="weak">弱网</option>
      <option value="call">通话</option>
      <option value="live" selected="selected">直播</option>
    </select>
  </div>

  <br />
  <br />
  <button onclick="start()">Start Comm</button>
  <button onclick="stop()">Stop Comm</button>
  <br />
  <p id="status">Disconnected</p>
  <p id="info">------</p>

  <script src="/socket.io/socket.io.js"></script>
  <!-- <script type="text/javascript">
    LIBOPUS_WASM_URL = "libopus.wasm";
  </script>
  <script type="text/javascript" src="libopus.wasm.js"></script> -->

  <script src="AudioControllerApi.js"></script>
  <script src="xaudio.js"></script>
  <script src="opus.js"></script>
  <script src="libopus.js"></script>
  <script src="DelayDetection.js"></script>
  <script src="sonic.js"></script>
  <script src="JitterBuffer.js"></script>
  <script src='mozjpeg_enc.js'></script>
  <script src="//unpkg.com/compressorjs@1.1.1/dist/compressor.js"></script>
  <script>

    var snCount = 0;
    var socket = io();
    var SyncTimer;
    var isStream = false;
    var isPlaying = false;
    var avgDelay = 0;
    var isLogin = false;
    const mozjpegEnc = mozjpeg_enc();

    //get pcm and encode
    var defaultConfig = {
      codec: {
        sampleRate: 8000,
        channels: 1,
        app: 2049,
        frameDuration: 20,
        bufferSize: 1024
      },
    };


    var delayDet = new DelayDetection();
    var streamer = null;
    var PlayerHandler = new Map();

    var chunks = [];

    //var player = new AudioControllerApi.Player(defaultConfig, socket, delayDet);

    // socket.on('SyncReqest', function (msg) {

    //   console.log("RevSyncSyncReqest:" + msg.sts);
    //   //let syncRespone = { timestamp: getTimestamp() }
    //   let syncRespone = {
    //               sts:getTimestamp()
    //             };
    //   socket.emit('SyncResponse', syncRespone);

    //   delayDet.updateTimestamp(msg.sts,undefined, getTimestamp());
    //   if (isStream == false) {
    //     streamer.start();
    //     isStream = true;
    //   }
    // });
    socket.on('SyncResponse', function (msg) {
      console.log("RevSyncResponse:" + msg.sts);
      clearInterval(SyncTimer);
      delayDet.updateTimestamp(msg.sts,undefined, getTimestamp());
      // if (isPlaying == false) {
      //   player.start();
      //   isPlaying = true;e
      // }
      if (isStream == false) {

        let configLive = {
          codec: {
            sampleRate: 48000,
            channels: 1,
            app: 2049,
            frameDuration: 20,
            bufferSize: 1024
          },
        };

        let configCall = {
          codec: {
            sampleRate: 24000,
            channels: 1,
            app: 2049,
            frameDuration: 20,
            bufferSize: 1024
          },
        };
        if(document.getElementById("audio_mode").value == "live"){
          streamer = new AudioControllerApi.Streamer(configLive, socket, delayDet);
        }else if(document.getElementById("audio_mode").value == "call"){
          streamer = new AudioControllerApi.Streamer(configCall, socket, delayDet);
        }else{
          streamer = new AudioControllerApi.Streamer(defaultConfig, socket, delayDet);
        }

        streamer.start();
        isStream = true;
      }
      document.getElementById("status").innerHTML = "Connected";
    });

    function start() {
      if(isLogin == false){
        window.alert("请先登入");
        console.log(document.getElementById("audio_mode").value);
        return;
      }
      SyncTimer = setInterval(function () { sendSyncReqest() }, 1000);
    }

    function stop() {
      streamer.stop();
     // player.stop();
     PlayerHandler.forEach((value,key)=>{
              value.stop();

            });
     PlayerHandler.clear();


      isStream = false;
      isPlaying = false;
      document.getElementById("status").innerHTML = "Disconnected";
    }

    function login() {
      const userName = document.getElementById('userName').value;
      socket.emit('login', { userName });

      isLogin = true;
    }

    function getTimestamp() {
      return Date.now();
    }

    function sendSyncReqest() {

      let syncReqest = {
                  sts:getTimestamp()
                };
      socket.emit('SyncReqest', syncReqest);
      console.log("SendSyncReqest:" + syncReqest.sts);
    }

    var myVar = setInterval(function () { myTimer() }, 1000);
    function myTimer() {
      let info = "";
      PlayerHandler.forEach((value,key)=>{
          info = info+value.userName +":&nbsp;&nbsp;网络状况(0-30:好,30-80:中,>80:差):"+(delayDet.getDelay()+value.pushDelay)+",通话延迟:"+Math.floor(value.getStashBufLen().getLength()/48)+"ms"+"<br />";
      });
      document.getElementById("info").innerHTML = info;

    }

    socket.on("audio", function (msg) {
      console.log(msg.data)
      if(PlayerHandler.has(msg.id) == false){
         let player = new AudioControllerApi.Player(defaultConfig, socket, delayDet,msg.name,msg.samplerate);
         player.start();
         PlayerHandler.set(msg.id,player);
      }

      if(PlayerHandler.has(msg.id)){
         PlayerHandler.get(msg.id).pushAudio(msg);
      }
    });


    socket.on("audio-break", function (msg) {
      if(PlayerHandler.has(msg.id)){
        PlayerHandler.get(msg.id).stop();
         PlayerHandler.delete(msg.id);
      }
    });

    socket.on("sync", function (msg) {
      delayDet.updateTimestamp(msg.sts,undefined, getTimestamp());
    });

    socket.on("disconnect", () => {
      console.log("服务器断开");
      stop();
    });

    socket.on("video", function (msg) {
      //console.log(msg);
      //chunks.push(msg);
    });

    var img = document.getElementById("target");
    var count =0 ;
    socket.on("capture", function (msg) {
      //console.log("recieve image"+count++);
      // const blob = dataURItoBlob(msg);

      var blob = new Blob( [msg], { type: "image/jpeg" } );
      var urlCreator = window.URL || window.webkitURL;
      var imageUrl = urlCreator.createObjectURL( blob ); 
      img.src = imageUrl;
    });




    function streamVideo() {
        let recorder = null;
        //let chunks = [];
        let video = document.getElementById("video");
        // let videoStream = document.getElementById("videoStream");
        // document.getElementById("play").addEventListener("click", start);
        navigator.mediaDevices.getDisplayMedia({ video: true }).then(stream => {
            video.srcObject = stream;
            // recorder = new MediaRecorder(stream);
            // recorder.start(1000);
            // recorder.ondataavailable = event => {
            //     //chunks.push(event.data);
            //     //socket.emit('video',event.data);
            //     //console.log(event.data);
            // };
            
        }).catch(error => {
            console.log(error);
        });
    }

    function startPlayVideo() {
      console.log("startPlayVideo");
            try {
                console.log("chunks", chunks);
                let blob = new Blob(chunks, {
                    type: 'video/mp4'
                });
                var url = window.URL.createObjectURL(blob);
                videoStream.src = url;
                console.log("videoStream", videoStream);
                videoStream.play();
            } catch (err) {
                console.log("err", err.message);
            }
    }
    //     /**
    //  * base64  to blob二进制
    //  */
    // function dataURItoBlob(dataURI) {
    //     var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0]; // mime类型
    //     var byteString = atob(dataURI.split(',')[1]); //base64 解码
    //     var arrayBuffer = new ArrayBuffer(byteString.length); //创建缓冲数组
    //     var intArray = new Uint8Array(arrayBuffer); //创建视图

    //     for (var i = 0; i < byteString.length; i++) {
    //         intArray[i] = byteString.charCodeAt(i);
    //     }
    //     return new Blob([intArray], {type: mimeString});
    // }

    // /**
    //  * 
    //  * blob二进制 to base64
    //  **/
    // function blobToDataURI(blob, callback) {
    //     var reader = new FileReader();
    //     reader.onload = function (e) {
    //         callback(e.target.result);
    //     }
    //     reader.readAsDataURL(blob);
    // }

    async function captureImage(){


      var myVar = setInterval(async function () { 
                        //let output = document.getElementById("output");
                        var canvas = document.createElement("canvas");
      canvas.width = 1280;
      canvas.height = 720;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // socket.emit('capture', canvas.toDataURL('image/jpeg'));

      // canvas.toBlob(async (blob) => {
      // //   // blobToDataURI(blob, (msg) => {
      // //   //   socket.emit('capture', msg);
      // //   // });
      // //   new Compressor(blob, {
      // //     quality: 1,

      // //     success(result) {
      // //       // var img2 = document.createElement("img");
      // //       // const base64String = btoa(String.fromCharCode.apply(null, new Uint8Array(result)));
      // //       // img2.src = URL.createObjectURL(base64String);
      // //       socket.emit('capture', result);
      // //     },
      // //     error(err) {
      // //       console.log(err.message);
      // //     },
      // //   });

      // }, 'image/jpeg');

      const start = new Date().getTime();
      const image = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const result = mozjpegEnc.encode(image.data, image.width, image.height, {
        quality: 30,
        baseline: false,
        arithmetic: false,
        progressive: true,
        optimize_coding: true,
        smoothing: 0,
        color_space: 3,
        quant_table: 3,
        trellis_multipass: false,
        trellis_opt_zero: false,
        trellis_opt_table: false,
        trellis_loops: 1,
        auto_subsample: true,
        chroma_subsample: 2,
        separate_chroma_quality: false,
        chroma_quality: 75,
      });
      // debugger
      console.log('cost - ', new Date().getTime() - start)

      // const blob = new Blob([result], {type: 'image/jpeg'});
      // const blobURL = URL.createObjectURL(blob);
      const imgBlob = new Blob([result], {type: 'image/jpeg'});
      const buff = await imgBlob.arrayBuffer();
      socket.emit('capture', buff);


                                          
                                          }, 500);

    }

    // function dataURItoBlob(dataURI){
    //   var byteString;
    //   if(dataURI.)
    // }




  </script>
</body>

</html>
